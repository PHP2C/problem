## 项目

公司的主要业务是量表。
类似考试，但是是量表测评。

一共有3个版本的项目：以下称之为v0,v1,v2

v0是一个很老的项目，用php5写的。自己封装了数据库操作，使用html嵌php代码实现。参与这个老项目的维护，主要包括一些小功能的增加和修改、



1. 介绍主要业务
2. 介绍在业务中的职责
3. 介绍完成了什么东西，达成了什么效果
4. 简述公司技术栈
5. 在项目中学到的东西

## 1 主要业务
目前在的这家公司，主要是做医疗行业的,主要业务是量表测评。包括与医院系统的对接。公司有3套系统，分别是最老版的v0，第一个项目v1，基于第一个项目的v2重构




## 2 在业务中的职责
### v0维护
这个比较麻烦，因为是php5写的，而且代码是php嵌入到html里面。在维护的时候，要用js老的版本，因为他内置的浏览器对js的版本比较旧，导致一次在维护的时候，找了很久的问题  

### v1项目的开发维
主要包括旧系统的维护，解决线上问题；与医院的系统对接，理解需求等。以及对量表原文件的抽象和编写。量表文件抽象之后，是一个固定格式的json文件，包含了原文件的所有内容。  
但是文件结构比较简单，但是手动写比较繁琐，且是毫无意义的重复动作，于是写了给个小的脚本，帮助生成文件内容，但是可能并不成熟，因为量表的情况有些很复杂，用代码实现出来比较繁琐  
对项目的小功能的增加  
对项目里的慢sql进行优化  
以及重构自己写过的代码  

### v1项目重构
包括量表服务的拆分与复用。将量表文件更加抽象，以满足不同的需求，比如，输入等；将算法抽离，不同的量表有各自的算法文件，方便进特异化处理。（因为之前的算法都是一个方法，）  
有量表需要进行特殊处理的之后，就在原来的量表方法里面加操作，导致这个算法文件越来越耦合，代码结构层次不是特别清晰。  
重构之后，提供最基础最通用的算法基础服务，每个量表都继承这个通用的算法服务，有特殊处理就在各自的算法里进行处理。  


### 3 完成了什么内容
#### 量表文件的梳理以及版本管理
之前量表文件比较散乱，同一个量表有n多个不同的版本，甚至不知道哪个版本是对的，于是整理并进行了量表版本管理

#### CT1 多个 HIS系统对接
每个医院的需求不一致，根据他们的需求进行处理  
有的需要保存量表报告成pdf，有写生成pdf的服务  
根据视图，或者量表服务进行写。

#### 技术栈
PHP8.1 PHP7.3 ThinkPHP5.1 ThinkPHP6 MySQL5.7 Redis


#### 代码优化
优化了在开发环境下能跑，但是在服务器上慢代码。
1. 问题出现的原因：在foreach里面insert和update；服务器是HDD，本地开发环境是SSD；update是为了构造上下级，但是包含了本级的id，insert一条update一条，所以导致很慢
2. 解决：在foreach里面整合了insert数据，一次写入，减少数据连接（因为PHP没有连接池，每次数据库操作都要重新连接，然后释放）。然后把update舍弃了，又少了一半的连接和更新操作
3. 本地从3s优化到300ms以内，线上1分半优化到1s以内

#### 代码重构
1. 重构自己写过的代码，还是又很多地方可以优化。
2. 例子：比如团体excel模板和个人excel模板，需要进行自定义信息来更改模板。最开始写的是团体的模板，尽量抽象，但是后来发现并不通用
3. 解决办法：于是将写入excel，当作一个通用的方法，用set方法来写入保存的路径，数据，然后规定了数据的格式。抽离了各自的数据清洗和组装。  通用方法只解析数据并根据路径写入excel

#### 代码重构2
1. 导出excel 这个接口巨慢，原来业务逻辑是，读取了所有的数据，然后返回到前端做分页统计，，，，相当于每次都要把所有的数据查询出来。而且导出excel和查询数据耦合在一个接口。。。
2. 优化了查询，虽然还是很慢

#### 代码重构3
1. 之前有写过一个团体的功能，为了保证数据的完整性和一致性，在写入和更新数据的时候，做了很多存在验证，就导致代码看起来很混乱
2. 重构：收到验证器的unique的启发，自己封装了一层验证器，自己封装了一个通用的验证器规则，验证字段是否存在；是否唯一等。使代码结构层次更加清晰了


### 公司技术栈
v0使用的是php5.7版本，还有自己封装的赋值模板。
v1使用的是php7.3.4版本，以及ThinkPHP5.1框架
v2使用的是php8.1版本

#### v2
代码分层

数据一致

返回结果枚举

REST api风格

业务与服务分离